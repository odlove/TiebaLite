# 当前 theme 系统重构未完成, 基本属于不可用状态!!!



# TiebaLite 主题界面行为说明

> 最近更新：2025-11-04

本文件优先从 UI 视角说明主题设置页的交互逻辑，确保“动态取色 / 自定义颜色 / 透明主题 / 夜间模式 / 跟随系统夜间”之间的关系清晰，再在后续补充底层状态机细节。

## UI 行为模型总览

- **主题模式分组**：`夜间模式开关`、`跟随系统夜间`、当前状态摘要。
- **颜色策略分组**：`动态取色`、`自定义主色`、`工具栏使用主色`。
- **透明主题分组**：`启用透明主题`、背景预览、模糊/透明度滑条。

界面应以卡片或列表分隔这三类分组，并在顶部提供实时状态摘要，例如“夜间 · 动态取色 · 透明背景”。

## 布局与信息层级

1. **状态摘要栏**：展示 `effectiveTheme`、夜间/日间标识、动态色/透明状态；提供“恢复默认”操作入口。
2. **主题模式卡片**：
   - `跟随系统夜间`（复选）放在首行，决定夜间开关是否可用。
   - `夜间模式开关` 紧随其后，以切换按钮或开关呈现。
   - `夜间主题选择器`（可选）供用户选择默认夜间主题。
3. **颜色策略卡片**：
   - `动态取色` 开关。
   - `自定义主色` 行为按钮（进入颜色选择对话框）。
   - `工具栏使用主色` 开关，说明其影响范围。
4. **透明主题卡片**：
   - `启用透明主题` 开关。
   - 透明背景预览（含示例截图）。
   - 模糊强度与透明度滑条。

## 控件交互矩阵

| 控件 | 可交互条件 | 调用动作 | 联动效果 |
| --- | --- | --- | --- |
| `跟随系统夜间` | 始终可用 | 选中：进入系统驱动模式；取消：回到手动控制。 | 选中时禁用 `夜间模式开关` 并显示当前系统状态。 |
| `夜间模式开关` | `跟随系统夜间` 未选中 | 根据当前状态调用 `toggleNightMode()`（日→夜需缓存旧主题，夜→日恢复旧主题）。 | 成功后刷新状态摘要和调色板预览。 |
| `动态取色` | API ≥ 31 且当前主题支持动态色 | `setUseDynamicTheme(flag)`。不满足条件时自动退回关闭态。 | 开启时禁用 `自定义主色`，并在提示文案说明原因。 |
| `自定义主色` | 当前未开启动态取色，且主题允许自定义 | 打开调色器，确认后写入 `customPrimaryColor` 并刷新。 | 若打开动态取色，应提示将清空自定义颜色。 |
| `工具栏使用主色` | 永久可用 | 写入 `toolbarPrimaryColor`，刷新调色板。 | 预览区即时展示切换效果。 |
| `启用透明主题` | 主题支持透明模式（`ThemeType.TRANSLUCENT`） | 切换对应透明主题（内部调用 `switchTheme`），保留夜间/日间属性。 | 打开后显示模糊与透明度控制；关闭时恢复原主题。 |
| 模糊/透明度滑条 | `启用透明主题` 为开 | 更新 `translucent*`，并触发轻量刷新预览。 | 不影响夜间或动态色状态。 |

## 典型用户流程

1. **开启跟随系统夜间**：
   - 勾选后立即读取系统当前模式并展示；夜间开关置灰。
   - 系统切换事件到达时 UI 监听 `ThemeState.isNightMode` 自动刷新。
2. **纯手动夜间切换**：
   - 取消“跟随系统”，用户通过夜间开关在日/夜间主题间切换。
   - 切至夜间时提示“返回日间将恢复到 {oldThemeLabel}”。
3. **动态取色与自定义颜色冲突处理**：
   - 当开启动态取色时，自定义按钮置灰并给出说明。
   - 若用户关闭动态取色，保留上一次自定义颜色并立即恢复调色板。
4. **透明主题调优**：
   - 启用透明主题后，滑条实时影响预览。
   - 关闭透明主题时恢复到启用前的日/夜间主题，确保 `rawTheme` 不变。

## 提示与异常状态

- 动态取色在不支持的 API 或主题下，开关需禁用并显示“当前设备/主题不支持动态取色”。
- 首次进入夜间而 `oldTheme` 为空时，夜→日切换应提示“将恢复到默认主题”。
- 透明主题可能造成性能或耗电上升，在开关旁提供提示文本。
- 当仓库读取失败或关键字段缺失时，界面应回落到默认主题并弹出“已恢复默认主题设置”。


